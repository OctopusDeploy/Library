{
  "Id": "ActionTemplates-12",
  "Name": "MSMQ Transactional Queues",
  "Description": "Create an MSMQ Transactional Queue and configure permissions.",
  "ActionType": "Octopus.Script",
  "Version": 2,
  "Properties": {
    "Octopus.Action.Script.ScriptBody": "#Split the Queues into an array\r\n$arrQueues = $strMSMQQueues.split(\";\")\r\nforeach ($Queue in $arrQueues) \r\n{\r\n\t#Does Queue Exists Already?\r\n\t$thisQueue = Get-MSMQQueue $Queue\r\n\r\n\tif (!$thisQueue)\r\n\t{\r\n\t\t#not found, create\r\n\t\tWrite-Host \"Creating Queue: \" $Queue\r\n\t\tNew-MsmqQueue -Name \"$Queue\" -Transactional | Out-Null\r\n\t\t$thisQueue = Get-MSMQQueue $Queue\t\r\n\t}\r\n\telse\r\n\t{\r\n\t\t#keep rolling\r\n\t\tWrite-Host \"Queue Exists: \" $thisQueue.QueueName\r\n\t}\r\n\r\n\t#set acl for users\r\n\t$arrUsers = $strMSMQUsers.split(\";\")\r\n\tforeach ($User in $arrUsers) \t\r\n\t{\t\r\n\t\tif ($User)\r\n\t\t{\t\r\n\t\t\t$ACLS = \"\"\r\n\t\t\tWrite-Host \"    Adding ACL for User: \" $User\t\t\r\n\t\t\t\r\n\t\t\t#fullcontrol\r\n\t\t\tif ($User.Contains('Domain Admins'))\r\n\t\t\t{\r\n\t\t\t\t$thisQueue | Set-MsmqQueueAcl –UserName $User –Allow $strMSMQPermFull  | Out-Null\t\t\t\t\r\n\t\t\t\tWrite-Host \"        ACL Allow set: $strMSMQPermFull\"`n\r\n\t\t\t}\r\n\t\t\telse\t\t\t\t\r\n\t\t\t{\r\n\t\t\t\t#allows\r\n\t\t\t\t$arrPermissions = $strMSMQPermAllow.split(\";\")\r\n\t\t\t\tforeach ($Permission in $arrPermissions) \t\r\n\t\t\t\t{\r\n\t\t\t\t\t$thisQueue | Set-MsmqQueueAcl –UserName $User –Allow $Permission  | Out-Null\t\t\t\t\r\n\t\t\t\t\t$ACLS = \"$Permission,$ACLS\"\t\t\t\t\r\n\t\t\t\t}\t\t\r\n\t\t\t\tWrite-Host \"        ACL Allow set: $ACLS\"\r\n\t\t\t\t#denies\r\n\t\t\t\t$thisQueue | Set-MsmqQueueAcl –UserName $User –Deny $strMSMQPermDeny  | Out-Null\r\n\t\t\t\tWrite-Host \"        ACL Deny  set: $strMSMQPermDeny\"`n\r\n\t\t\t}\r\n\t\t}\r\n\t}\t\r\n}"
  },
  "SensitiveProperties": {},
  "Parameters": [
    {
      "Name": "$strMSMQUsers",
      "Label": "MSMQ Users",
      "HelpText": "Define Users: Domain\\User1;Domain\\User2",
      "DefaultValue": ".\\Administrators"
    },
    {
      "Name": "$strMSMQQueues",
      "Label": "MSMQ Queue Names",
      "HelpText": "Queue Names: Queue1;Queue2;Queue3",
      "DefaultValue": "Queue1"
    },
    {
      "Name": "$strMSMQPermAllow",
      "Label": "MSMQ Allowed Permissions",
      "HelpText": "Queue Permissions: \"DeleteMessage;PeekMessage;ReceiveMessage;WriteMessage\"",
      "DefaultValue": "DeleteMessage;PeekMessage;ReceiveMessage;WriteMessage"
    },
    {
      "Name": "$strMSMQPermDeny",
      "Label": "MSMQ Deny Permission",
      "HelpText": "MSMQ denied Permissions: \"TakeQueueOwnership\"",
      "DefaultValue": "TakeQueueOwnership"
    },
    {
      "Name": "$strMSMQPermFull",
      "Label": "MSMQ Full Permissions",
      "HelpText": "MSMQ Full Permissions: \"FullControl\"",
      "DefaultValue": "FullControl"
    }
  ],
  "LastModifiedOn": "2014-05-15T19:56:51.549+00:00",
  "LastModifiedBy": "cminman@app.mcn",
  "$Meta": {
    "ExportedAt": "2014-05-15T20:13:42.096Z",
    "OctopusVersion": "2.4.5.46",
    "Type": "ActionTemplate"
  }
}
